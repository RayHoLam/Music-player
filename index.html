<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Music Player</title>
</head>
<body>
<div class="container">
    <h1>Music Player</h1>
    <input type="text" id="search" placeholder="Search for tracks...">
    <ul id="track-list"></ul>
    <button id="play">搜索後點擊曲目名稱</button>
    <audio id="audio"></audio>
</div>
<script type="module">
    const searchInput = document.getElementById('search');
    const trackList = document.getElementById('track-list');
    const playBtn = document.getElementById('play');
    const audio = document.getElementById('audio');

    import * as id from './id.js';
    import * as client from './client.js';

    let accessToken = ''; 

    async function initialize() {
        const resultA = await id.decryptData(encryptedData, key, iv);
        const resultB = await client.decryptData(encryptedData, key, iv);
        await getAccessToken(resultA, resultB);
    }

    async function getAccessToken(resultA, resultB) {
        const basicAuth = btoa(`${resultA}:${resultB}`);
        
        const response = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${basicAuth}`,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'grant_type=client_credentials'
        });

        const data = await response.json();
        accessToken = data.access_token;
    }

    async function searchTracks(query) {
        try {
            const response = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            displayTracks(data.tracks.items.slice(0, 5));
        } catch (error) {
            console.error('Error fetching tracks:', error);
        }
    }

    function displayTracks(tracks) {
        trackList.innerHTML = '';
        tracks.forEach(track => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.innerText = `${track.name} - ${track.artists[0].name}`;
            span.style.cursor = 'pointer';
            span.onclick = () => playTrack(track.preview_url);
            li.appendChild(span);
            trackList.appendChild(li);
        });
    }

    function playTrack(url) {
        if (url) {
            audio.src = url;
            audio.play();
        }
    }

    playBtn.addEventListener('click', () => {
        if (audio.paused) {
            audio.play();
            playBtn.innerText = 'Pause';
        } else {
            audio.pause();
            playBtn.innerText = 'Play';
        }
    });

    searchInput.addEventListener('input', () => {
        const query = searchInput.value;
        if (query) {
            searchTracks(query);
        }
    });

    // Initialize the app
    initialize();
</script>
</body>
</html>
